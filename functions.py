import mysql.connector
from mysql.connector import Error
from read_xlsx import *

import datetime


def verifier_etudiant_exist(cursor, matricule):
    sql = "SELECT * FROM Etudiant WHERE matricule = %s"
    
    cursor.execute(sql, (matricule,))

    etudiants = cursor.fetchall()
    
    if etudiants:
        
        return True
    else:
        
        return False


def verifier_etudiant_inscrit(cursor, matricule, semestre):
    sql = "SELECT * FROM Inscrire WHERE matricule = %s AND Semestre = %s"
    
    cursor.execute(sql, (matricule, semestre))

    etudiants = cursor.fetchall()
    
    if etudiants:
        
        return True
    else:
        
        return False


def insert_etudiant(cursor, matricule, nom, prenom, sexe, lieu_naissance, date_naissance):
    
    test = verifier_etudiant_exist(cursor, matricule)
    
    if not test:
        try:
            cursor.execute("""
                INSERT INTO Etudiant (matricule, NomsEtu, PrenomEtu, Sexe, LieuNais, DateNais)
                VALUES (%s, %s, %s, %s, %s, %s)
                ON DUPLICATE KEY UPDATE
                    NomsEtu = VALUES(NomsEtu),
                    PrenomEtu = VALUES(PrenomEtu),
                    Sexe = VALUES(Sexe),
                    LieuNais = VALUES(LieuNais),
                    DateNais = VALUES(DateNais)
            """, (matricule, nom, prenom, sexe, lieu_naissance, date_naissance))
        except Error as e:
            print(f"Erreur lors de l'insertion ou de la mise Ã  jour de l'Ã©tudiant : {e}")
            return False
        return True
    else:
        print(f"Erreur lors de l'ajout de l'Ã©tudiant car il existe dÃ©jÃ ")
        return False 

def insert_etudiant_list_of_tuples(cursor, etudiants):
    """
    InsÃ¨re une liste de tuples d'Ã©tudiants dans la base de donnÃ©es.
    """
    print(etudiants)
    try:
        cursor.executemany("""
            INSERT INTO Etudiant (matricule, NomsEtu, PrenomEtu, Sexe, LieuNais, DateNais)
            VALUES (%s, %s, %s, %s, %s, %s)
            ON DUPLICATE KEY UPDATE
                NomsEtu = VALUES(NomsEtu),
                PrenomEtu = VALUES(PrenomEtu),
                Sexe = VALUES(Sexe),
                LieuNais = VALUES(LieuNais),
                DateNais = VALUES(DateNais)
        """, etudiants)
        print('Everything okay !')
    except Error as e:
        print(f"Erreur lors de l'insertion ou de la mise Ã  jour des Ã©tudiants : {e}")
        return False
    return True

def update_etudiant(cursor, matricule, nom, prenom, sexe, lieu_naissance, date_naissance):
    
    try:
        cursor.execute("""
            INSERT INTO Etudiant (matricule, NomsEtu, PrenomEtu, Sexe, LieuNais, DateNais)
            VALUES (%s, %s, %s, %s, %s, %s)
            ON DUPLICATE KEY UPDATE
                NomsEtu = VALUES(NomsEtu),
                PrenomEtu = VALUES(PrenomEtu),
                Sexe = VALUES(Sexe),
                LieuNais = VALUES(LieuNais),
                DateNais = VALUES(DateNais)
        """, (matricule, nom, prenom, sexe, lieu_naissance, date_naissance))
    except Error as e:
        print(f"Erreur lors de l'insertion ou de la mise Ã  jour de l'Ã©tudiant : {e}")
        return False
    return True


def insert_promotion(desi_promo, conn):
        
        # RequÃªte SQL pour insÃ©rer ou mettre Ã  jour la promotion
        query = """
        INSERT INTO Promotion (DesiPromo)
        VALUES (%s)
        ON DUPLICATE KEY UPDATE
            DesiPromo = VALUES(DesiPromo);
        """
        
        params = (desi_promo,)
        
        cursor = conn.cursor()
        cursor.execute(query, params)
        
        
        conn.commit()
        print("Promotion ajoutÃ©e ou mise Ã  jour avec succÃ¨s.")


def insert_inscription(cursor, matricule, id_promo, annÃ©e_acadÃ©mique, semestre):

    test = verifier_etudiant_inscrit(cursor, matricule, semestre)
    if not test:
        try:
            cursor.execute("""
                INSERT INTO Inscrire (matricule, id_promo, AnneeAcademique, Semestre)
                VALUES (%s, %s, %s, %s)
                ON DUPLICATE KEY UPDATE
                    AnneeAcademique = VALUES(AnneeAcademique),
                    Semestre = VALUES(Semestre)
            """, (matricule, id_promo, annÃ©e_acadÃ©mique, semestre))
        except Error as e:
            print(f"Erreur lors de l'insertion ou de la mise Ã  jour de l'inscription : {e}")
            return False
        return True
    else:
        print(f"Erreur lors de l'ajout de l'inscription car l'Ã©tudiant est dÃ©jÃ  inscrit Ã  ce semestre")
        return False 


def connect_to_db():
    # Connexion Ã  la base de donnÃ©es MySQL
    try:
        conn = mysql.connector.connect(
            host='localhost',
            user='root',  
            password='',  
            database='GestNotes'
        )
        if conn.is_connected():
            print('Connexion rÃ©ussie Ã  la base de donnÃ©es.')
            return conn
    except Error as e:
        print(f"Erreur de connexion Ã  la base de donnÃ©es : {e}")
        return None


def inscrire_ajouter_etudiant(conn, matricule, nom, prenom, sexe, lieu_naissance, date_naissance, id_promo, annÃ©e_acadÃ©mique, semestre):
    cursor = conn.cursor()

    if insert_etudiant(cursor, matricule, nom, prenom, sexe, lieu_naissance, date_naissance):
        print("Ã‰tudiant ajoutÃ© avec succÃ¨s.")
    
        if insert_inscription(cursor, matricule, id_promo, annÃ©e_acadÃ©mique, semestre):
            print("Inscription ajoutÃ©e avec succÃ¨s.")
        
        print('Good ðŸ˜‚ðŸ˜‚ðŸŽ‰')
    else:
        print('Bad ðŸ˜‚ðŸ˜‚ðŸŽ‰')
    
    cursor.close()
    conn.commit() 
    
    
def get_etudiant(conn, matricule):
    cursor = conn.cursor()
    
    try:
        sql = "SELECT * FROM Etudiant WHERE matricule = %s "
        cursor.execute(sql, (matricule,))
        return cursor.fetchall()
    except Error as e:
        print(f"Erreur lors de la recupÃ©ration des etudiants de la promotion : {e}")
        

def get_etudiant_by_promotion_per_semester(conn, promotion, semestre):
    cursor = conn.cursor()
    etudiants = []
    
    try:
        # SQL query to get student matricules based on promotion and semester
        sql = """
        SELECT E.matricule, E.NomsEtu, E.PrenomEtu, E.Sexe, E.LieuNais, E.DateNais
        FROM Etudiant E
        JOIN Inscrire I ON E.matricule = I.matricule
        WHERE I.id_promo = %s AND I.Semestre = %s
        """
        cursor.execute(sql, (promotion, semestre))
        etudiant_data = cursor.fetchall()
        
        # Process each student and append their data in the required format
        for etudiant in etudiant_data:
            etudiants.append((
                etudiant[0],  # matricule
                etudiant[1],  # NomEtu
                etudiant[2],  # PrenomEtu
                etudiant[3],  # Sexe
                etudiant[4],  # LieuNais
                etudiant[5]   # DateNais (should be a datetime object)
            ))
        
        return etudiants
    except Error as e:
        print(f"Erreur lors de la rÃ©cupÃ©ration des Ã©tudiants de la promotion : {e}")
        return etudiants
    
    
def get_etudiant_by_promotion(conn, promotion):
    
    cursor = conn.cursor()
    etudiants = []
    
    try:
        sql = "SELECT * FROM Inscrire WHERE id_promo = %s"
        cursor.execute(sql, (promotion,))
        inscriptions = cursor.fetchall()
        
        for inscription in inscriptions:
            etudiants.append(get_etudiant(conn, inscription[1]))
        
        return etudiants
    except Error as e:
        print(f"Erreur lors de la recupÃ©ration des etudiants de la promotion : {e}")
        
        return etudiants
    

def inscrire_etudiant_depuis_excel(path, conn, id_promo, annee_academique, semestre):
    """
    InsÃ¨re les Ã©tudiants et leurs inscriptions Ã  partir d'un fichier Excel.
    """
    data = get_data_from_excel(path)

    for item in data:
        cursor = conn.cursor()
        matricule = item["matricule"]
        nom = item["nom"]
        prenom = item["prenom"]
        sexe = item["sexe"]
        lieu_naissance = item["lieunais"]
        date_naissance = item["datenais"]
        
        # VÃ©rifier si l'Ã©tudiant existe dÃ©jÃ 
        cursor.execute("SELECT COUNT(*) FROM Etudiant WHERE matricule = %s", (matricule,))
        etudiant_existe = cursor.fetchone()[0] > 0
        
        if not etudiant_existe:
            try:
                cursor.execute("""
                    INSERT INTO Etudiant (matricule, NomsEtu, PrenomEtu, Sexe, LieuNais, DateNais)
                    VALUES (%s, %s, %s, %s, %s, %s)
                    ON DUPLICATE KEY UPDATE
                        NomsEtu = VALUES(NomsEtu),
                        PrenomEtu = VALUES(PrenomEtu),
                        Sexe = VALUES(Sexe),
                        LieuNais = VALUES(LieuNais),
                        DateNais = VALUES(DateNais)
                """, (matricule, nom, prenom, sexe, lieu_naissance, date_naissance))
                print(f"Ã‰tudiant {matricule} ajoutÃ© avec succÃ¨s.")
            except Error as e:
                print(f"Erreur lors de l'insertion de l'Ã©tudiant {matricule} : {e}")
                continue
        else:
            print(f"L'Ã©tudiant {matricule} existe dÃ©jÃ .")
        
        # VÃ©rifier si l'Ã©tudiant est dÃ©jÃ  inscrit Ã  ce semestre
        cursor.execute("""
            SELECT COUNT(*) FROM Inscrire WHERE matricule = %s AND Semestre = %s
        """, (matricule, semestre))
        inscription_existe = cursor.fetchone()[0] > 0
        
        if not inscription_existe:
            try:
                cursor.execute("""
                    INSERT INTO Inscrire (matricule, id_promo, AnneeAcademique, Semestre)
                    VALUES (%s, %s, %s, %s)
                    ON DUPLICATE KEY UPDATE
                        AnneeAcademique = VALUES(AnneeAcademique),
                        Semestre = VALUES(Semestre)
                """, (matricule, id_promo, annee_academique, semestre))
                print(f"Inscription de l'Ã©tudiant {matricule} ajoutÃ©e avec succÃ¨s.")
            except Error as e:
                print(f"Erreur lors de l'inscription de l'Ã©tudiant {matricule} : {e}")
                
        else:
            print(f"L'Ã©tudiant {matricule} est dÃ©jÃ  inscrit Ã  ce semestre.")
    
        conn.commit()
    cursor.close()
    print('=======================================')
    print('Inscription rÃ©ussie Ã  la base de donnÃ©es.')
    print('=======================================')
    conn.close()
    
    return True

def authentification_appariteur():
    pass

def get_promotions(conn):
    cursor = conn.cursor()
    
    try:
        sql = "SELECT * FROM Promotion "
        cursor.execute(sql)
        return cursor.fetchall()
    except Error as e:
        print(f"Erreur lors de la recupÃ©ration des etudiants de la promotion : {e}")